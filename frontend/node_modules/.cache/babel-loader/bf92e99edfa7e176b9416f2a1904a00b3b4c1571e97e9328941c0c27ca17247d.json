{"ast":null,"code":"import React,{useState,useEffect}from'react';import{useLocalStorage}from'../hooks/useLocalStorage';import{FileDown,Image,Layers,RefreshCw}from'lucide-react';import{formatCurrency,formatPercentage}from'../utils/dataParser';import{calculateOrcadoPorAgencia,calculateRealizadoPorAgencia,calculateRealizadoPorCarteira,calculateAtingimento,getAtingimentoColor,getAtingimentoClass,groupByRede,sortByScoreMedio}from'../utils/calculations';import{exportToPNG,exportAllRedes,THEME_VARIANTS}from'../utils/exportUtils';import{toast}from'sonner';import{jsx as _jsx,jsxs as _jsxs}from\"react/jsx-runtime\";const RankingExport=()=>{const[produtos]=useLocalStorage('challenge_produtos',[]);const[carteiras]=useLocalStorage('carteiras_master',[]);const[orcadosPorTipo]=useLocalStorage('orcados_por_tipo',[]);const[orcadosPorCarteira]=useLocalStorage('orcados_por_carteira',[]);const[redes]=useLocalStorage('redes',[]);const[realizadosTipo]=useLocalStorage('realizados_tipo',[]);const[realizadosCarteira]=useLocalStorage('realizados_carteira',[]);const[realizadosDiariosTipo]=useLocalStorage('realizados_tipo_diarios',[]);const[realizadosDiariosCarteira]=useLocalStorage('realizados_carteira_diarios',[]);const[diasDesafio]=useLocalStorage('challenge_dias',30);const[unidade,setUnidade]=useState('agencia');const[nomeDesafio,setNomeDesafio]=useLocalStorage('nome_desafio','');// Auto-save no localStorage\nconst[temaIndex,setTemaIndex]=useState(0);const[baseCalculo,setBaseCalculo]=useState('carteira');const[rankingData,setRankingData]=useState([]);const[diaFiltro,setDiaFiltro]=useState(null);const hasCarteirasData=realizadosCarteira.length>0;const tema=THEME_VARIANTS[temaIndex];const produtosRanking=[...produtos];if(produtos.includes('Vida')){const vidaIndex=produtosRanking.indexOf('Vida');produtosRanking[vidaIndex]='Vida Total';}// Calcula tamanhos dinâmicos baseado no número de produtos\nconst numProdutos=unidade==='agencia'?produtosRanking.length:1;const numColunas=3+numProdutos*3;// Posição, Prefixo, Dependência + (Orçado + Realizado + % para cada produto)\n// Ajusta tamanho de fonte e padding baseado no número de produtos\nconst getFontSize=()=>{if(numProdutos<=3)return'14px';if(numProdutos<=5)return'12px';return'10px';};const getPadding=()=>{if(numProdutos<=3)return'12px';if(numProdutos<=5)return'10px';return'8px';};const getHeaderFontSize=()=>{if(numProdutos<=3)return'42px';if(numProdutos<=5)return'36px';return'32px';};const getSubHeaderFontSize=()=>{if(numProdutos<=3)return'28px';if(numProdutos<=5)return'24px';return'20px';};const fontSize=getFontSize();const padding=getPadding();const headerFontSize=getHeaderFontSize();const subHeaderFontSize=getSubHeaderFontSize();const calculateRanking=()=>{if(unidade==='agencia'){const prefixosUnicos=[...new Set(carteiras.map(c=>c.prefixo).filter(Boolean))];const rankings=prefixosUnicos.map(prefixo=>{var _carteirasPrefixo$;const carteirasPrefixo=carteiras.filter(c=>c.prefixo===prefixo);const agencia=((_carteirasPrefixo$=carteirasPrefixo[0])===null||_carteirasPrefixo$===void 0?void 0:_carteirasPrefixo$.agencia)||prefixo;const redeInfo=redes.find(r=>r.prefixo===prefixo);const rede=(redeInfo===null||redeInfo===void 0?void 0:redeInfo.rede)||'Sem Rede';const useCarteiraBase=baseCalculo==='carteira'&&orcadosPorCarteira.length>0;const orcado=calculateOrcadoPorAgencia(prefixo,carteiras,orcadosPorTipo,orcadosPorCarteira,useCarteiraBase);const atingimentos={};const valores={};const orcadosPorProduto={};// Calcular orçado por produto\n// Primeiro, contar quantas carteiras de cada tipo esta agência tem\nconst tiposCount={};carteirasPrefixo.forEach(cart=>{const tipo=cart.tipoCarteira;if(tipo){tiposCount[tipo]=(tiposCount[tipo]||0)+1;}});produtosRanking.forEach(produto=>{// Calcular orçado para este produto específico\nlet orcadoProduto=0;// Mapear \"Vida Total\" para \"Vida\" nos orçamentos\nconst produtoBusca=produto==='Vida Total'?'Vida':produto;// Para cada tipo de carteira, multiplicar orçado × quantidade\nObject.entries(tiposCount).forEach(_ref=>{let[tipo,qtd]=_ref;const orcadoTipo=orcadosPorTipo.find(o=>o.tipoCarteira===tipo&&o.produto===produtoBusca);if(orcadoTipo){orcadoProduto+=(parseFloat(orcadoTipo.valor)||0)*qtd;}});orcadosPorProduto[produto]=orcadoProduto;// Usa realizadosDiariosTipo se houver dados, senão usa realizadosTipo\nlet realizado=0;if(realizadosDiariosTipo.length>0){// Soma todos os dias salvos até diaFiltro para este prefixo e produto\nconst diaLimite=diaFiltro||diasDesafio;realizado=realizadosDiariosTipo.filter(r=>r.prefixo===prefixo&&r.produto===produto&&r.dia<=diaLimite).reduce((sum,r)=>sum+(parseFloat(r.valor)||0),0);// Se for Vida Total, soma Vida + Vidinha\nif(produto==='Vida Total'){const vida=realizadosDiariosTipo.filter(r=>r.prefixo===prefixo&&r.produto==='Vida'&&r.dia<=diaLimite).reduce((sum,r)=>sum+(parseFloat(r.valor)||0),0);const vidinha=realizadosDiariosTipo.filter(r=>r.prefixo===prefixo&&r.produto==='Vidinha'&&r.dia<=diaLimite).reduce((sum,r)=>sum+(parseFloat(r.valor)||0),0);realizado=vida+vidinha;}}else{// Fallback para realizadosTipo (compatibilidade)\nrealizado=calculateRealizadoPorAgencia(prefixo,produto,realizadosTipo,diaFiltro);}valores[produto]=realizado;atingimentos[produto]=calculateAtingimento(realizado,orcadoProduto);});return{prefixo,agencia,rede,orcado,valores,atingimentos,orcadosPorProduto};});return sortByScoreMedio(rankings);}else{const rankingsCarteira=[];carteiras.forEach(c=>{const redeInfo=redes.find(r=>r.prefixo===c.prefixo);const rede=(redeInfo===null||redeInfo===void 0?void 0:redeInfo.rede)||'Sem Rede';const orcadoCarteira=orcadosPorCarteira.find(o=>o.prefixo===c.prefixo&&o.carteira===c.carteira);const orcado=orcadoCarteira?orcadoCarteira.valor*(orcadoCarteira.fatorMeta||100)/100:0;// Usa realizadosDiariosCarteira se houver dados, senão usa realizadosCarteira\nlet realizado=0;if(realizadosDiariosCarteira.length>0){// Soma todos os dias salvos até diaFiltro para esta carteira\nconst diaLimite=diaFiltro||diasDesafio;realizado=realizadosDiariosCarteira.filter(r=>r.prefixo===c.prefixo&&r.carteira===c.carteira&&r.dia<=diaLimite).reduce((sum,r)=>sum+(parseFloat(r.valor)||0),0);}else{// Fallback para realizadosCarteira (compatibilidade)\nrealizado=calculateRealizadoPorCarteira(c.prefixo,c.carteira,realizadosCarteira,diaFiltro);}const atingimento=calculateAtingimento(realizado,orcado);rankingsCarteira.push({prefixo:c.prefixo,agencia:c.agencia,carteira:c.carteira,rede,orcado,valores:{Total:realizado},atingimentos:{Total:atingimento}});});return sortByScoreMedio(rankingsCarteira);}};const handleAtualizarRanking=()=>{const data=calculateRanking();setRankingData(data);toast.success('Ranking atualizado!');};const handleExportPNGGeral=async()=>{await exportToPNG('ranking-export-all',\"ranking-geral-\".concat(nomeDesafio||'desafio',\".png\"));toast.success('Exportação concluída!');};const handleExportPNGRedes=async()=>{const redesUnicas=[...new Set(redes.map(r=>r.rede).filter(Boolean))];if(redesUnicas.length===0){toast.error('Nenhuma rede configurada');return;}await exportAllRedes(redesUnicas);toast.success('Exportação de todas as redes concluída!');};useEffect(()=>{if(carteiras.length>0){handleAtualizarRanking();}},[unidade,baseCalculo,diaFiltro]);const redesAgrupadas=groupByRede(rankingData,redes);const redesUnicas=Object.keys(redesAgrupadas);return/*#__PURE__*/_jsxs(\"div\",{children:[/*#__PURE__*/_jsxs(\"div\",{className:\"bb-card\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"bb-card-header\",children:[/*#__PURE__*/_jsx(\"h2\",{className:\"bb-card-title\",\"data-testid\":\"ranking-export-title\",children:\"Campo 8 \\u2014 Ranking & Exporta\\xE7\\xE3o\"}),/*#__PURE__*/_jsx(\"p\",{className:\"bb-card-subtitle\",children:\"Configure, visualize e exporte o ranking do desafio\"})]}),/*#__PURE__*/_jsxs(\"div\",{style:{display:'grid',gridTemplateColumns:'repeat(auto-fit, minmax(250px, 1fr))',gap:'16px',marginBottom:'24px'},children:[/*#__PURE__*/_jsxs(\"div\",{children:[/*#__PURE__*/_jsx(\"label\",{style:{display:'block',marginBottom:'8px',fontWeight:600,color:'var(--bb-gray-700)',fontSize:'14px'},children:\"Unidade do Ranking:\"}),/*#__PURE__*/_jsxs(\"select\",{value:unidade,onChange:e=>setUnidade(e.target.value),className:\"bb-input\",\"data-testid\":\"unidade-select\",children:[/*#__PURE__*/_jsx(\"option\",{value:\"agencia\",children:\"Ag\\xEAncia (Prefixo)\"}),/*#__PURE__*/_jsxs(\"option\",{value:\"carteiras\",disabled:!hasCarteirasData,children:[\"Carteiras \",!hasCarteirasData?'(sem dados)':'']})]})]}),/*#__PURE__*/_jsxs(\"div\",{children:[/*#__PURE__*/_jsx(\"label\",{style:{display:'block',marginBottom:'8px',fontWeight:600,color:'var(--bb-gray-700)',fontSize:'14px'},children:\"Nome do Desafio:\"}),/*#__PURE__*/_jsx(\"input\",{type:\"text\",value:nomeDesafio,onChange:e=>setNomeDesafio(e.target.value),className:\"bb-input\",placeholder:\"Ex: Desafio Q1 2025\",\"data-testid\":\"nome-desafio-input\"})]}),/*#__PURE__*/_jsxs(\"div\",{children:[/*#__PURE__*/_jsx(\"label\",{style:{display:'block',marginBottom:'8px',fontWeight:600,color:'var(--bb-gray-700)',fontSize:'14px'},children:\"Tema Visual:\"}),/*#__PURE__*/_jsx(\"select\",{value:temaIndex,onChange:e=>setTemaIndex(parseInt(e.target.value)),className:\"bb-input\",\"data-testid\":\"tema-select\",children:THEME_VARIANTS.map((t,idx)=>/*#__PURE__*/_jsx(\"option\",{value:idx,children:t.name},idx))})]}),unidade==='agencia'&&/*#__PURE__*/_jsxs(\"div\",{children:[/*#__PURE__*/_jsx(\"label\",{style:{display:'block',marginBottom:'8px',fontWeight:600,color:'var(--bb-gray-700)',fontSize:'14px'},children:\"Base de C\\xE1lculo:\"}),/*#__PURE__*/_jsxs(\"select\",{value:baseCalculo,onChange:e=>setBaseCalculo(e.target.value),className:\"bb-input\",\"data-testid\":\"base-calculo-select\",children:[/*#__PURE__*/_jsx(\"option\",{value:\"carteira\",children:\"Por Carteira\"}),/*#__PURE__*/_jsx(\"option\",{value:\"tipo\",children:\"Por Tipo\"})]})]}),/*#__PURE__*/_jsxs(\"div\",{children:[/*#__PURE__*/_jsx(\"label\",{style:{display:'block',marginBottom:'8px',fontWeight:600,color:'var(--bb-gray-700)',fontSize:'14px'},children:\"Filtrar at\\xE9 o Dia:\"}),/*#__PURE__*/_jsxs(\"select\",{value:diaFiltro||'',onChange:e=>setDiaFiltro(e.target.value?parseInt(e.target.value):null),className:\"bb-input\",\"data-testid\":\"dia-filtro-select\",children:[/*#__PURE__*/_jsx(\"option\",{value:\"\",children:\"Todos os dias\"}),Array.from({length:diasDesafio},(_,i)=>i+1).map(dia=>/*#__PURE__*/_jsxs(\"option\",{value:dia,children:[\"At\\xE9 Dia \",dia]},dia))]})]})]}),/*#__PURE__*/_jsxs(\"div\",{style:{display:'flex',flexWrap:'wrap',gap:'12px',marginBottom:'24px'},children:[/*#__PURE__*/_jsxs(\"button\",{onClick:handleAtualizarRanking,className:\"bb-btn bb-btn-primary\",\"data-testid\":\"atualizar-ranking-btn\",children:[/*#__PURE__*/_jsx(RefreshCw,{size:16}),\"Atualizar Ranking\"]}),/*#__PURE__*/_jsxs(\"button\",{onClick:handleExportPNGGeral,className:\"bb-btn bb-btn-secondary\",disabled:rankingData.length===0,\"data-testid\":\"export-png-geral-btn\",children:[/*#__PURE__*/_jsx(Image,{size:16}),\"Exportar PNG (Geral)\"]}),/*#__PURE__*/_jsxs(\"button\",{onClick:handleExportPNGRedes,className:\"bb-btn bb-btn-secondary\",disabled:redesUnicas.length===0,\"data-testid\":\"export-png-redes-btn\",children:[/*#__PURE__*/_jsx(Layers,{size:16}),\"Exportar PNG (Todas as Redes)\"]})]})]}),rankingData.length>0&&/*#__PURE__*/_jsx(\"div\",{id:\"ranking-export-all\",className:\"export-container\",style:{background:'white',padding:numProdutos>5?'20px':'40px',borderRadius:'12px',width:'fit-content',minWidth:'100%'},children:redesUnicas.map(rede=>{const dadosRede=redesAgrupadas[rede]||[];if(dadosRede.length===0)return null;return/*#__PURE__*/_jsxs(\"div\",{id:\"ranking-rede-\".concat(rede.replace(/\\s+/g,'-')),style:{marginBottom:'48px',pageBreakAfter:'always'},children:[/*#__PURE__*/_jsxs(\"div\",{style:{background:tema.headerBg,color:tema.headerColor,padding:numProdutos>5?'24px 20px':'32px 24px',borderRadius:'12px 12px 0 0',marginBottom:'0'},children:[/*#__PURE__*/_jsx(\"h1\",{style:{fontSize:headerFontSize,fontWeight:'700',marginBottom:'12px',textAlign:'center',lineHeight:'1.2'},children:nomeDesafio||'Ranking de Desafios de Seguridade'}),/*#__PURE__*/_jsxs(\"p\",{style:{fontSize:subHeaderFontSize,fontWeight:'600',textAlign:'center',color:tema.accentColor,lineHeight:'1.3'},children:[\"Rede \",rede]})]}),/*#__PURE__*/_jsx(\"div\",{style:{overflowX:'auto',border:'2px solid #e8eef7',borderTop:'none',borderRadius:'0 0 12px 12px'},children:/*#__PURE__*/_jsxs(\"table\",{style:{width:'100%',borderCollapse:'collapse',background:'white',fontSize},children:[/*#__PURE__*/_jsx(\"thead\",{children:/*#__PURE__*/_jsxs(\"tr\",{style:{background:'var(--bb-blue)',color:'white'},children:[/*#__PURE__*/_jsx(\"th\",{style:{padding,textAlign:'left',fontSize,fontWeight:'600',position:'sticky',top:0,background:'var(--bb-blue)',whiteSpace:'nowrap'},children:\"Pos.\"}),/*#__PURE__*/_jsx(\"th\",{style:{padding,textAlign:'left',fontSize,fontWeight:'600',position:'sticky',top:0,background:'var(--bb-blue)',whiteSpace:'nowrap'},children:\"Prefixo\"}),/*#__PURE__*/_jsx(\"th\",{style:{padding,textAlign:'left',fontSize,fontWeight:'600',position:'sticky',top:0,background:'var(--bb-blue)',whiteSpace:'nowrap'},children:\"Depend\\xEAncia\"}),unidade==='carteiras'&&/*#__PURE__*/_jsx(\"th\",{style:{padding,textAlign:'left',fontSize,fontWeight:'600',position:'sticky',top:0,background:'var(--bb-blue)',whiteSpace:'nowrap'},children:\"Carteira\"}),(unidade==='agencia'?produtosRanking:['Total']).map((produto,pIdx)=>{// Cores mais escuras para os cabeçalhos dos produtos\nconst headerCores=['#1976d2',// Azul\n'#f57c00',// Laranja\n'#388e3c',// Verde\n'#7b1fa2',// Roxo\n'#fbc02d',// Amarelo\n'#c2185b',// Rosa\n'#00796b'// Ciano\n];const headerBg=headerCores[pIdx%headerCores.length];return/*#__PURE__*/_jsxs(React.Fragment,{children:[/*#__PURE__*/_jsxs(\"th\",{style:{padding,textAlign:'right',fontSize,fontWeight:'600',position:'sticky',top:0,background:headerBg,whiteSpace:'nowrap'},children:[produto,/*#__PURE__*/_jsx(\"br\",{}),\"Or\\xE7ado\"]}),/*#__PURE__*/_jsxs(\"th\",{style:{padding,textAlign:'right',fontSize,fontWeight:'600',position:'sticky',top:0,background:headerBg,whiteSpace:'nowrap'},children:[produto,/*#__PURE__*/_jsx(\"br\",{}),\"Realizado\"]}),/*#__PURE__*/_jsxs(\"th\",{style:{padding,textAlign:'right',fontSize,fontWeight:'600',position:'sticky',top:0,background:headerBg,whiteSpace:'nowrap'},children:[produto,/*#__PURE__*/_jsx(\"br\",{}),\"%\"]})]},produto);})]})}),/*#__PURE__*/_jsx(\"tbody\",{children:dadosRede.map((item,idx)=>{// Cores alternadas mais visíveis para as linhas\nconst rowBgColor=idx%2===0?'#ffffff':'#f0f4f8';// Array de cores suaves para cada produto\nconst produtoCores=[{bg:'#e3f2fd',bgAlt:'#d1e7f7'},// Azul claro\n{bg:'#fff3e0',bgAlt:'#ffe4c4'},// Laranja claro\n{bg:'#e8f5e9',bgAlt:'#d4ead5'},// Verde claro\n{bg:'#f3e5f5',bgAlt:'#e1d4e3'},// Roxo claro\n{bg:'#fff9c4',bgAlt:'#ffeb99'},// Amarelo claro\n{bg:'#fce4ec',bgAlt:'#f8d0dd'},// Rosa claro\n{bg:'#e0f2f1',bgAlt:'#c8e6e4'}// Ciano claro\n];return/*#__PURE__*/_jsxs(\"tr\",{style:{borderBottom:'1px solid #e8eef7',background:rowBgColor},children:[/*#__PURE__*/_jsxs(\"td\",{style:{padding,fontSize,fontWeight:'600',background:rowBgColor},children:[idx+1,\"\\xBA\"]}),/*#__PURE__*/_jsx(\"td\",{style:{padding,fontSize,background:rowBgColor},children:item.prefixo}),/*#__PURE__*/_jsx(\"td\",{style:{padding,fontSize,background:rowBgColor},children:item.agencia}),unidade==='carteiras'&&/*#__PURE__*/_jsx(\"td\",{style:{padding,fontSize,background:rowBgColor},children:item.carteira}),(unidade==='agencia'?produtosRanking:['Total']).map((produto,pIdx)=>{var _item$orcadosPorProdu;// Usa uma cor diferente para cada produto, com variação para linhas alternadas\nconst corProduto=produtoCores[pIdx%produtoCores.length];const bgProduto=idx%2===0?corProduto.bg:corProduto.bgAlt;return/*#__PURE__*/_jsxs(React.Fragment,{children:[/*#__PURE__*/_jsx(\"td\",{style:{padding,fontSize,textAlign:'right',fontWeight:'600',background:bgProduto},children:formatCurrency(((_item$orcadosPorProdu=item.orcadosPorProduto)===null||_item$orcadosPorProdu===void 0?void 0:_item$orcadosPorProdu[produto])||0)}),/*#__PURE__*/_jsx(\"td\",{style:{padding,fontSize,textAlign:'right',background:bgProduto},children:formatCurrency(item.valores[produto]||0)}),/*#__PURE__*/_jsx(\"td\",{style:{padding,fontSize,textAlign:'right',fontWeight:'600',color:getAtingimentoColor(item.atingimentos[produto]||0),background:bgProduto},children:formatPercentage(item.atingimentos[produto]||0)})]},produto);})]},idx);})})]})})]},rede);})}),rankingData.length===0&&/*#__PURE__*/_jsx(\"div\",{className:\"bb-card\",children:/*#__PURE__*/_jsxs(\"div\",{style:{padding:'32px',textAlign:'center',color:'var(--bb-gray-600)'},children:[/*#__PURE__*/_jsx(FileDown,{size:48,style:{margin:'0 auto 16px',opacity:0.5}}),/*#__PURE__*/_jsx(\"p\",{style:{fontSize:'16px'},children:\"Clique em \\\"Atualizar Ranking\\\" para gerar os dados\"})]})})]});};export default RankingExport;","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}